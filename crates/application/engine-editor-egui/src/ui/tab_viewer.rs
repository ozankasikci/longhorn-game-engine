// Tab viewer implementation for the docking system

use eframe::egui;
use egui_dock::{TabViewer, NodeIndex, SurfaceIndex};
use crate::types::PanelType;
use crate::editor_state::ConsoleMessage;
use crate::LonghornEditor;

/// Wrapper to avoid borrowing conflicts when using TabViewer
pub struct EditorTabViewer<'a> {
    pub editor: &'a mut LonghornEditor,
}

impl<'a> TabViewer for EditorTabViewer<'a> {
    type Tab = PanelType;

    fn title(&mut self, tab: &mut Self::Tab) -> egui::WidgetText {
        match tab {
            PanelType::Hierarchy => "üèóÔ∏è Hierarchy".into(),
            PanelType::Inspector => "üîç Inspector".into(),
            PanelType::SceneView => "üé® Scene".into(),
            PanelType::GameView => "üéÆ Game".into(),
            PanelType::Console => "üñ•Ô∏è Console".into(),
            PanelType::Project => "üìÅ Project".into(),
        }
    }

    fn ui(&mut self, ui: &mut egui::Ui, tab: &mut Self::Tab) {
        match tab {
            PanelType::Hierarchy => self.editor.show_hierarchy_panel(ui),
            PanelType::Inspector => self.editor.show_inspector_panel(ui),
            PanelType::SceneView => self.editor.show_scene_view(ui),
            PanelType::GameView => self.editor.show_game_view(ui),
            PanelType::Console => self.editor.show_console_panel(ui),
            PanelType::Project => self.editor.show_project_panel(ui),
        }
    }

    fn context_menu(&mut self, ui: &mut egui::Ui, tab: &mut Self::Tab, _surface: SurfaceIndex, _node: NodeIndex) {
        if ui.button("Close Tab").clicked() {
            self.editor.console_messages.push(ConsoleMessage::info(&format!("üóëÔ∏è Closed {:?} panel", tab)));
            ui.close_menu();
        }
        if ui.button("Duplicate Tab").clicked() {
            // Note: We can't modify dock_state here since it's already borrowed
            self.editor.console_messages.push(ConsoleMessage::info(&format!("üìã Duplicated {:?} panel", tab)));
            ui.close_menu();
        }
    }
}